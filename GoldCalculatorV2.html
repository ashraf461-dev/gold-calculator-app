<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة أسعار الذهب</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- QR Code Scanner Library (html5-qrcode) -->
    <script src="https://unpkg.com/html5-qrcode@2.3.4/umd/html5-qrcode.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 500px;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 24px;
        }
        /* Custom styling for the Modal backdrop and content */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal.open {
            display: flex;
        }
        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 12px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        #reader {
            width: 100%;
            min-height: 250px;
            border: 2px solid #ef4444;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container">
        <h1 class="text-3xl font-bold text-center text-yellow-600 mb-6 border-b pb-3">حاسبة سعر الذهب</h1>

        <!-- قسم الإدخالات (الأسعار والوزن) -->
        <div class="space-y-4">
            <!-- سعر الجرام الحالي -->
            <div>
                <label for="current-price" class="block text-sm font-medium text-gray-700 mb-1">سعر الجرام الحالي ($)</label>
                <input type="number" id="current-price" value="70.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 text-right" placeholder="أدخل سعر الجرام بالدولار">
            </div>

            <!-- العيار -->
            <div>
                <label for="carat-select" class="block text-sm font-medium text-gray-700 mb-1">العيار (قيراط)</label>
                <select id="carat-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 bg-white text-right">
                    <option value="24" data-pure-gold="1">عيار 24 (ذهب نقي)</option>
                    <option value="22" data-pure-gold="0.9167">عيار 22</option>
                    <option value="21" data-pure-gold="0.875" selected>عيار 21</option>
                    <option value="18" data-pure-gold="0.750">عيار 18</option>
                    <option value="14" data-pure-gold="0.5833">عيار 14</option>
                </select>
            </div>

            <!-- الوزن بالجرام -->
            <div>
                <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">الوزن (جرام)</label>
                <input type="number" id="weight" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 text-right" placeholder="أدخل الوزن بالجرام">
            </div>
            
            <!-- زر المسح بالكاميرا -->
            <button id="scan-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-200">
                مسح بالكاميرا (رمز المنتج / QR)
            </button>
        </div>

        <!-- قسم النتائج -->
        <div class="mt-8 pt-6 border-t border-gray-200 space-y-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">النتائج والحسابات:</h2>

            <!-- سعر الجرام الصافي للعيار المختار -->
            <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                <span class="text-sm font-medium text-gray-600">سعر جرام الذهب الصافي (للعيار):</span>
                <span id="carat-price" class="text-lg font-bold text-yellow-700">0.00 $</span>
            </div>
            
            <!-- سعر الذهب النهائي للبيع للعميل -->
            <div class="p-4 bg-red-100 border-2 border-red-400 rounded-xl">
                <span class="block text-lg font-medium text-red-700">السعر النهائي للبيع للعميل:</span>
                <span id="final-price" class="block text-4xl font-extrabold text-red-900 mt-1">0.00 $</span>
            </div>
        </div>
    </div>

    <!-- النافذة المنبثقة للماسح الضوئي (Scanner Modal) -->
    <div id="scanner-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">مسح كود المنتج</h2>
            <p id="reader-message" class="text-sm text-gray-600 mb-4">وجه الكاميرا نحو الباركود/الكيو آر كود.</p>
            
            <!-- مساحة عرض الكاميرا/الماسح الضوئي -->
            <div id="reader"></div>

            <p class="text-xs text-gray-500 mb-4">سيتم إغلاق النافذة تلقائياً عند نجاح المسح.</p>
            
            <button id="close-scanner-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-200">
                إلغاء
            </button>
        </div>
    </div>

    <script type="module">
        // ===========================================
        // // PART 1: FIREBASE INITIALIZATION AND AUTH
        // // ===========================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');
        
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAuthReady = false;

        if (firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Handle Authentication
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Sign in anonymously if no token is available or user is signed out
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Sign-In Error:", error);
                            // Fallback to random ID if sign-in fails
                            userId = crypto.randomUUID();
                        }
                    }
                    isAuthReady = true;
                    console.log("Auth Ready. User ID:", userId);
                    if (userId) {
                         // Start listening to data once authenticated
                        startListeningToData();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        } else {
            console.error("Firebase config is not available.");
            isAuthReady = true; // Still allow app to run, but without persistence
            userId = crypto.randomUUID();
        }

        // ===========================================
        // // PART 2: FIREBASE DATA HANDLING (PRICES)
        // // ===========================================
        const CURRENT_PRICE_COLLECTION = 'goldPrices';
        const PRICE_DOC_ID = 'latest';

        const currentPriceInput = document.getElementById('current-price');

        /**
         * Gets the Firestore document reference for the latest price.
         * Stores public data in: /artifacts/{appId}/public/data/goldPrices/latest
         */
        const getPriceDocRef = () => {
             // Use a public path so all users share the same price data
            const path = `/artifacts/${appId}/public/data/${CURRENT_PRICE_COLLECTION}/${PRICE_DOC_ID}`;
            return doc(db, path);
        };
        
        /**
         * Starts real-time listening for gold price updates from Firestore.
         */
        function startListeningToData() {
            if (!db || !isAuthReady) return;

            console.log("Starting onSnapshot listener for gold price...");
            const priceDocRef = getPriceDocRef();

            onSnapshot(priceDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const newPrice = data.price;
                    if (newPrice !== parseFloat(currentPriceInput.value)) {
                        currentPriceInput.value = newPrice.toFixed(2);
                        console.log("Price updated from Firestore:", newPrice);
                        calculateFinalPrice(); // Recalculate upon price change
                    }
                } else {
                    console.log("No price data found in Firestore, setting default.");
                    // Save the default value back to Firestore if not found
                    updatePriceInFirestore(parseFloat(currentPriceInput.value));
                }
            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
            });
        }

        /**
         * Updates the gold price in Firestore.
         * @param {number} price - The new current gold price.
         */
        async function updatePriceInFirestore(price) {
            if (!db || !isAuthReady) {
                console.warn("Database or Auth not ready. Cannot save price.");
                return;
            }
            try {
                const priceDocRef = getPriceDocRef();
                await setDoc(priceDocRef, { price: price, lastUpdated: new Date() }, { merge: true });
                console.log("Price saved to Firestore:", price);
            } catch (error) {
                console.error("Error writing price to Firestore:", error);
            }
        }

        // ===========================================
        // // PART 3: CALCULATIONS AND UI LOGIC
        // // ===========================================
        const weightInput = document.getElementById('weight');
        const caratSelect = document.getElementById('carat-select');
        const caratPriceElement = document.getElementById('carat-price');
        const finalPriceElement = document.getElementById('final-price');

        /**
         * Calculates the gold price based on current price, weight, and carat.
         */
        function calculateFinalPrice() {
            const currentPrice = parseFloat(currentPriceInput.value) || 0;
            const weight = parseFloat(weightInput.value) || 0;
            const selectedOption = caratSelect.options[caratSelect.selectedIndex];
            const pureGoldRatio = parseFloat(selectedOption.getAttribute('data-pure-gold')) || 0;

            // 1. Calculate price of 1 gram of the selected carat
            const pricePerGram = currentPrice * pureGoldRatio;
            
            // 2. Calculate final price (Price * Weight)
            const finalPrice = pricePerGram * weight;

            // Update UI elements
            caratPriceElement.textContent = `${pricePerGram.toFixed(2)} $`;
            finalPriceElement.textContent = `${finalPrice.toFixed(2)} $`;
        }
        
        // Event Listeners for UI interaction
        currentPriceInput.addEventListener('input', () => {
            calculateFinalPrice();
            // Also update the price in Firestore when the user changes it
            updatePriceInFirestore(parseFloat(currentPriceInput.value) || 0);
        });
        weightInput.addEventListener('input', calculateFinalPrice);
        caratSelect.addEventListener('change', calculateFinalPrice);

        // Initial calculation on load
        calculateFinalPrice();

        // ===========================================
        // // PART 4: QR CODE SCANNER LOGIC
        // // ===========================================
        const scanButton = document.getElementById('scan-button');
        const modal = document.getElementById('scanner-modal');
        const closeModalButton = document.getElementById('close-scanner-button');
        const readerMessageElement = document.getElementById('reader-message');

        let html5QrCode = null;

        /**
         * Closes the scanner modal and stops the camera.
         */
        function closeScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    console.log("QR Code scanning stopped.");
                }).catch(err => {
                    console.error("Error stopping QR Code scanner:", err);
                });
            }
            modal.classList.remove('open');
            readerMessageElement.textContent = 'وجه الكاميرا نحو الباركود/الكيو آر كود.';
        }

        /**
         * Handles successful QR code scan.
         * @param {string} decodedText - The result of the scan.
         */
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            console.log("Scan successful:", decodedText);
            
            // Check if the decoded text is a number
            if (!isNaN(parseFloat(decodedText))) {
                const scannedWeight = parseFloat(decodedText);
                weightInput.value = scannedWeight; // Set the weight input
                calculateFinalPrice();             // Recalculate price
                readerMessageElement.textContent = 'تم قراءة الكود بنجاح!';
                setTimeout(closeScanner, 500); // Close after a short delay
            } else {
                 readerMessageElement.textContent = `تم مسح كود غير رقمي: ${decodedText}. يرجى محاولة مسح الوزن (رقم) أو كود آخر.`;
            }
        };

        /**
         * Starts the QR code scanner (Camera).
         */
        async function startScanner() {
            modal.classList.add('open');
            readerMessageElement.textContent = '...جاري البحث عن الكاميرا.';

            // Check if the library is loaded and available
            if (typeof Html5Qrcode === 'undefined') {
                readerMessageElement.textContent = 'خطأ: لم يتم تحميل مكتبة قارئ الكود. تأكد من اتصالك بالإنترنت.';
                console.error("Html5Qrcode library not found.");
                return;
            }

            // Initialize the scanner object only once
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }

            // Configuration for the scanner
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                supportedScanTypes: [
                    Html5QrcodeSupportedDevices.FRONT_CAMERA,
                    Html5QrcodeSupportedDevices.REAR_CAMERA,
                    Html5QrcodeSupportedDevices.USER
                ]
            };

            try {
                // Start scanning
                await html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback, (errorMessage) => {
                    // Update the message on continuous failure/error
                    if (errorMessage.includes("no camera has been found")) {
                         readerMessageElement.textContent = 'لم يتم العثور على كاميرا. تأكد من سماح المتصفح بالوصول للكاميرا.';
                    } else if (!html5QrCode.isScanning) {
                        // Only update if not already scanning successfully
                        readerMessageElement.textContent = '...جاري بدء تشغيل الكاميرا.';
                    }
                });
                console.log("Scanner started successfully.");
                readerMessageElement.textContent = 'الكاميرا جاهزة. وجهها نحو الكود.';
            } catch (err) {
                console.error("Failed to start scanner:", err);
                readerMessageElement.textContent = `فشل تشغيل الكاميرا: ${err.message || 'خطأ غير معروف'}.`;
            }
        }
        
        // Scanner Button Event Listener
        scanButton.addEventListener('click', startScanner);
        closeModalButton.addEventListener('click', closeScanner);
        
        // Close modal when clicking outside (on the backdrop)
        modal.addEventListener('click', (e) => {
            if (e.target.id === 'scanner-modal') {
                closeScanner();
            }
        });
    </script>
</body>
</html>
