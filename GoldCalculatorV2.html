<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'gold': '#FFD700',
                    'dark-gold': '#CCAD00',
                    'emerald': '#10B981',
                }
            },
            fontFamily: {
                // استخدام خط يدعم اللغة العربية بشكل جيد
                'sans': ['Cairo', 'Inter', 'Arial', 'sans-serif'],
            },
        }
    }
</script>

<style>
    /* استيراد الخط العربي */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
    
    body {
        background-color: #f7f7f7;
        direction: rtl;
        font-family: 'Cairo', sans-serif;
    }
    .card {
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    input[type="number"], input[type="text"], select {
        transition: all 0.2s;
        border: 1px solid #e5e7eb;
    }
    input[type="number"]:focus, input[type="text"]:focus, select:focus {
        border-color: #FFD700;
        box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.5);
    }
    .btn-gold {
        background-color: #FFD700;
        color: #333;
        transition: background-color 0.2s, transform 0.1s;
    }
    .btn-gold:hover {
        background-color: #CCAD00;
        transform: translateY(-1px);
    }
    .btn-gold:active {
        transform: translateY(1px);
    }
    .btn-emerald {
        background-color: #10B981;
        color: white;
        transition: background-color 0.2s, transform 0.1s;
    }
    .btn-emerald:hover {
        background-color: #059669;
        transform: translateY(-1px);
    }
    .btn-emerald:active {
        transform: translateY(1px);
    }

    /* Modal Styling */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
    }
    .modal-content {
        background-color: white;
        padding: 24px;
        border-radius: 12px;
        max-width: 90%;
        width: 400px;
    }
    .hidden {
        display: none;
    }

    /* Scanner/Video Stream Styling */
    #scanner-video {
        width: 100%;
        height: auto;
        border-radius: 8px;
        background-color: #333;
    }

    /* Highlight the calculation result */
    #finalPriceResult {
        font-size: 1.75rem; /* text-3xl */
        font-weight: 700; /* font-bold */
        color: #B91C1C; /* A strong red for emphasis */
    }
</style>

<div class="max-w-xl mx-auto p-4 sm:p-6 lg:p-8">
    <div class="bg-white p-6 md:p-8 rounded-xl card space-y-6">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 border-b pb-4 mb-4">حاسبة سعر الذهب النهائية</h1>

        <!-- قسم تحديث الأسعار (إلزامي) -->
        <div class="bg-gray-50 p-4 rounded-lg border-2 border-dashed border-dark-gold/50">
            <h2 class="text-xl font-bold mb-3 text-dark-gold">تحديث أسعار السوق (إلزامي)</h2>
            <div class="grid grid-cols-3 gap-3">
                <div>
                    <label for="price24" class="text-sm font-medium text-gray-700 block mb-1">24 عيار</label>
                    <input type="number" id="price24" value="230" placeholder="سعر 24" class="w-full p-2 rounded-lg" min="0" step="0.01">
                </div>
                <div>
                    <label for="price21" class="text-sm font-medium text-gray-700 block mb-1">21 عيار</label>
                    <input type="number" id="price21" value="200" placeholder="سعر 21" class="w-full p-2 rounded-lg" min="0" step="0.01">
                </div>
                <div>
                    <label for="price18" class="text-sm font-medium text-gray-700 block mb-1">18 عيار</label>
                    <input type="number" id="price18" value="170" placeholder="سعر 18" class="w-full p-2 rounded-lg" min="0" step="0.01">
                </div>
            </div>
            <button onclick="applyPrices()" class="btn-gold w-full mt-4 p-3 rounded-xl font-bold">تطبيق الأسعار الجديدة</button>
            <p id="priceStatus" class="mt-2 text-center text-sm text-emerald font-semibold">الأسعار الحالية: 24 (230) | 21 (200) | 18 (170)</p>
        </div>

        <!-- حقول إدخال البيانات -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="goldWeight" class="text-sm font-medium text-gray-700 block mb-1">الوزن (جرام)</label>
                <input type="number" id="goldWeight" placeholder="0.00" class="w-full p-3 rounded-lg bg-gray-50" min="0" step="0.001">
            </div>
            <div>
                <label for="goldCarat" class="text-sm font-medium text-gray-700 block mb-1">العيار</label>
                <select id="goldCarat" class="w-full p-3 rounded-lg bg-gray-50">
                    <option value="24">24</option>
                    <option value="21" selected>21</option>
                    <option value="18">18</option>
                </select>
            </div>
            <div>
                <label for="manufactureFee" class="text-sm font-medium text-gray-700 block mb-1">المصنعية (لكل جرام)</label>
                <input type="number" id="manufactureFee" value="10" placeholder="0.00" class="w-full p-3 rounded-lg bg-gray-50" min="0" step="0.01">
            </div>
            <div>
                <label for="stampFee" class="text-sm font-medium text-gray-700 block mb-1">رسوم الدمغة (لكل قطعة)</label>
                <input type="number" id="stampFee" value="50" placeholder="0.00" class="w-full p-3 rounded-lg bg-gray-50" min="0" step="0.01">
            </div>
        </div>

        <!-- زر المسح بالكاميرا - تم حذف كلمة (تجريبي) والتحذير المرتبط بها -->
        <button id="scanButton" onclick="openScannerModal()" class="btn-emerald w-full p-3 rounded-xl font-bold">
            مسح بالكاميرا
        </button>

        <!-- زر الحساب الرئيسي -->
        <button onclick="calculatePrice()" class="btn-gold w-full p-4 rounded-xl font-extrabold text-lg shadow-lg">احسب السعر النهائي</button>
        
        <!-- ملخص المنتج (للكود الممسوح ضوئياً) -->
        <p id="productSummary" class="text-center text-sm text-gray-600 h-6"></p>

        <!-- منطقة النتيجة النهائية -->
        <div class="text-center bg-red-50 p-4 rounded-lg border-2 border-red-300">
            <p class="text-base text-gray-600 mb-2">السعر النهائي للبيع للعميل:</p>
            <p id="finalPriceResult" class="text-3xl font-bold text-red-700">0.00</p>
            <p class="text-sm text-gray-500">ج.م.</p>
        </div>

        <!-- زر نسخ الملخص -->
        <button onclick="copySummary()" class="bg-blue-600 hover:bg-blue-700 text-white w-full p-3 rounded-xl font-bold shadow-md">
            نسخ الملخص الاحترافي
        </button>
        <p id="copyStatus" class="text-center text-sm text-blue-600 font-semibold h-4"></p>
    </div>

    <p class="text-center text-xs text-gray-500 mt-4">حاسبة الذهب لمحل <span id="storeNameDisplay">متجر الذهب</span> | الإصدار 2.0</p>
</div>


<!-- Modal for Camera Scanner -->
<div id="scannerModal" class="modal-overlay hidden">
    <div class="modal-content text-center">
        <h3 class="text-xl font-bold mb-4">مسح كود المنتج</h3>
        <p class="text-gray-600 mb-4">وجه الكاميرا نحو الباركود/الكيو آر كود. </p>
        
        <!-- Video element for the scanner -->
        <video id="scanner-video" playsinline></video>
        
        <p class="text-sm text-gray-500 mt-4">سيتم إغلاق النافذة تلقائيًا عند نجاح المسح.</p>

        <button onclick="closeScannerModal()" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg mt-4 w-full">إلغاء</button>
    </div>
</div>

<script type="module">
    // --- متغيرات الأسعار العالمية ---
    let prices = {
        '24': 230,
        '21': 200,
        '18': 170
    };

    // --- كتالوج المنتجات (Product Catalog) ---
    // الكود الذي يتم مسحه ضوئياً يجب أن يتطابق مع مفتاح في هذا الكتالوج.
    // يرجى تحديث هذا الكتالوج ليشمل جميع منتجات المحل.
    const PRODUCT_CATALOG = {
        // مفتاح الكود (الباركود/QR) : { اسم, وزن, عيار, مصنعية_لكل_جرام, دمغة_قطعة }
        "12345": { name: "خاتم ألماس", weight: 3.500, carat: '21', manufacture: 15.00, stamp: 75.00 },
        "67890": { name: "سلسلة ناعمة", weight: 8.250, carat: '18', manufacture: 12.50, stamp: 60.00 },
        "11223": { name: "طقم أطفال", weight: 15.100, carat: '24', manufacture: 8.00, stamp: 100.00 },
        "99999": { name: "تجربة سريعة", weight: 5.000, carat: '21', manufacture: 10.00, stamp: 50.00 },
    };
    
    // --- وظائف عامة ---

    // تحديث وعرض الأسعار العالمية
    window.applyPrices = function() {
        const price24 = parseFloat(document.getElementById('price24').value);
        const price21 = parseFloat(document.getElementById('price21').value);
        const price18 = parseFloat(document.getElementById('price18').value);

        if (isNaN(price24) || isNaN(price21) || isNaN(price18) || price24 <= 0 || price21 <= 0 || price18 <= 0) {
            document.getElementById('priceStatus').textContent = "يرجى إدخال أسعار صحيحة وموجبة.";
            document.getElementById('priceStatus').classList.remove('text-emerald');
            document.getElementById('priceStatus').classList.add('text-red-500');
            return;
        }

        prices['24'] = price24;
        prices['21'] = price21;
        prices['18'] = price18;

        document.getElementById('priceStatus').textContent = `الأسعار الحالية: 24 (${price24.toFixed(2)}) | 21 (${price21.toFixed(2)}) | 18 (${price18.toFixed(2)})`;
        document.getElementById('priceStatus').classList.add('text-emerald');
        document.getElementById('priceStatus').classList.remove('text-red-500');
    }

    // حساب السعر النهائي
    window.calculatePrice = function() {
        // 1. قراءة المدخلات
        const weight = parseFloat(document.getElementById('goldWeight').value) || 0;
        const carat = document.getElementById('goldCarat').value;
        const manufactureFeePerGram = parseFloat(document.getElementById('manufactureFee').value) || 0;
        const stampFee = parseFloat(document.getElementById('stampFee').value) || 0;

        // 2. التحقق من المدخلات الأساسية
        if (weight <= 0 || isNaN(weight) || !(carat in prices)) {
            document.getElementById('finalPriceResult').textContent = "0.00";
            document.getElementById('productSummary').textContent = "يرجى إدخال وزن صحيح واختيار العيار.";
            return;
        }

        const pricePerGram = prices[carat];
        
        // 3. حساب سعر الذهب الخام
        const rawGoldCost = weight * pricePerGram;
        
        // 4. حساب المصنعية
        const totalManufactureFee = weight * manufactureFeePerGram;

        // 5. حساب الإجمالي
        const finalPrice = rawGoldCost + totalManufactureFee + stampFee;

        // 6. عرض النتيجة
        document.getElementById('finalPriceResult').textContent = finalPrice.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        document.getElementById('productSummary').textContent = ''; // مسح الملخص إذا تم الحساب يدوياً
    }

    // نسخ ملخص الفاتورة
    window.copySummary = function() {
        calculatePrice(); // تأكد من الحساب قبل النسخ
        
        const weight = parseFloat(document.getElementById('goldWeight').value) || 0;
        const carat = document.getElementById('goldCarat').value;
        const manufactureFeePerGram = parseFloat(document.getElementById('manufactureFee').value) || 0;
        const stampFee = parseFloat(document.getElementById('stampFee').value) || 0;
        const finalPrice = document.getElementById('finalPriceResult').textContent;
        const storeName = document.getElementById('storeNameDisplay').textContent;
        const productSummaryText = document.getElementById('productSummary').textContent;

        if (finalPrice === '0.00') {
            document.getElementById('copyStatus').textContent = "لا يوجد سعر لحسابه أو نسخه.";
            return;
        }

        const summaryText = 
`--- فاتورة ${storeName} ---
${productSummaryText ? `${productSummaryText}\n` : ''}
العيار: ${carat}
الوزن: ${weight.toFixed(3)} جرام
سعر الخام (للعيار الحالي): ${prices[carat].toFixed(2)} ج.م.
المصنعية/جرام: ${manufactureFeePerGram.toFixed(2)} ج.م.
رسوم الدمغة: ${stampFee.toFixed(2)} ج.م.
--------------------------------
**السعر النهائي:** ${finalPrice} ج.م.
--------------------------------
نشكر ثقتكم بنا.
`;

        // استخدام Clipboard API لكفاءة النسخ (مع fallback إذا لم تنجح)
        navigator.clipboard.writeText(summaryText).then(() => {
            document.getElementById('copyStatus').textContent = "تم نسخ الملخص بنجاح!";
            setTimeout(() => document.getElementById('copyStatus').textContent = '', 3000);
        }).catch(err => {
            // Fallback for older browsers or restricted environments
            const textArea = document.createElement('textarea');
            textArea.value = summaryText;
            textArea.style.position = 'fixed'; // لتجنب التمرير إلى الأسفل
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    document.getElementById('copyStatus').textContent = "تم نسخ الملخص بنجاح! (باستخدام طريقة بديلة)";
                } else {
                    document.getElementById('copyStatus').textContent = "فشل النسخ، يرجى النسخ يدوياً.";
                }
            } catch (error) {
                document.getElementById('copyStatus').textContent = "فشل النسخ، يرجى النسخ يدوياً.";
            }
            document.body.removeChild(textArea);
            setTimeout(() => document.getElementById('copyStatus').textContent = '', 3000);
        });
    }

    // --- وظائف الماسح الضوئي (مكتبة QrScanner) ---

    let videoElement = null;
    let qrScanner = null;
    
    // تحميل مكتبة QrScanner بشكل ديناميكي
    function loadQrScannerScript(callback) {
        if (typeof QrScanner !== 'undefined') {
            callback();
            return;
        }
        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";
        script.onload = callback;
        document.head.appendChild(script);
    }

    // معالجة نتيجة المسح
    function handleScanResult(result) {
        const scannedCode = result.data;
        closeScannerModal(); // إغلاق النافذة فوراً

        const product = PRODUCT_CATALOG[scannedCode];

        if (product) {
            // ملء الحقول ببيانات المنتج
            document.getElementById('goldWeight').value = product.weight.toFixed(3);
            document.getElementById('goldCarat').value = product.carat;
            document.getElementById('manufactureFee').value = product.manufacture.toFixed(2);
            document.getElementById('stampFee').value = product.stamp.toFixed(2);
            document.getElementById('productSummary').textContent = `المنتج الممسوح: ${product.name} (كود: ${scannedCode})`;

            // حساب السعر النهائي تلقائياً
            calculatePrice();

        } else {
            // تنبيه المستخدم أن الكود غير موجود
            alertMessage(`الكود الممسوح (${scannedCode}) غير موجود في كتالوج المنتجات. يرجى إدخال البيانات يدوياً.`, 'red');
        }
    }

    // فتح نافذة الماسح الضوئي
    window.openScannerModal = function() {
        document.getElementById('scannerModal').classList.remove('hidden');
        
        loadQrScannerScript(() => {
            videoElement = document.getElementById('scanner-video');

            // إعداد الماسح الضوئي
            qrScanner = new QrScanner(
                videoElement,
                result => handleScanResult(result),
                {
                    onDecodeError: error => {
                        // تجاهل أخطاء عدم العثور على كود
                    },
                    highlightScanRegion: true,
                    highlightCodeOutline: true,
                }
            );
            
            // بدء تشغيل الكاميرا
            qrScanner.start().catch(err => {
                closeScannerModal();
                alertMessage("فشل تشغيل الكاميرا. تأكد من إعطاء الإذن أو حاول من متصفح آخر.", 'red');
                console.error("Camera start failed:", err);
            });
        });
    }

    // إغلاق نافذة الماسح الضوئي
    window.closeScannerModal = function() {
        if (qrScanner) {
            qrScanner.stop();
            qrScanner.destroy();
            qrScanner = null;
        }
        document.getElementById('scannerModal').classList.add('hidden');
    }
    
    // دالة لتنبيه المستخدم (بديل لـ alert)
    function alertMessage(message, color = 'blue') {
        const statusElement = document.getElementById('copyStatus'); // إعادة استخدام منطقة حالة النسخ للتبسيط
        statusElement.textContent = message;
        statusElement.classList.remove('text-blue-600', 'text-red-500', 'text-emerald');
        if (color === 'red') {
            statusElement.classList.add('text-red-500');
        } else if (color === 'green') {
            statusElement.classList.add('text-emerald');
        } else {
             statusElement.classList.add('text-blue-600');
        }
        setTimeout(() => statusElement.textContent = '', 5000);
    }

    // تطبيق الأسعار الافتراضية عند التحميل
    window.onload = () => {
        applyPrices();
    }
</script>
